--- old/src/share/classes/java/io/File.java	Thu Oct  9 16:11:01 2008
+++ openjdk/jdk/src/share/classes/java/io/File.java	Thu Oct  9 16:10:51 2008
@@ -32,9 +32,9 @@
 import java.util.ArrayList;
 import java.util.Map;
 import java.util.Hashtable;
-import java.util.Random;
 import java.security.AccessController;
 import java.security.AccessControlException;
+import java.security.SecureRandom;
 import sun.security.action.GetPropertyAction;
 
 
@@ -1676,30 +1676,30 @@
 
     /* -- Temporary files -- */
 
-    private static final Object tmpFileLock = new Object();
+    // lazy initialization of SecureRandom and temporary file directory
+    private static class LazyInitialization {
+        static final SecureRandom random = new SecureRandom();
 
-    private static int counter = -1; /* Protected by tmpFileLock */
+        static final String temporaryDirectory = temporaryDirectory();
+        static String temporaryDirectory() {
+            return fs.normalize(
+                AccessController.doPrivileged(
+                    new GetPropertyAction("java.io.tmpdir")));
+        }
+    }
 
     private static File generateFile(String prefix, String suffix, File dir)
         throws IOException
     {
-        if (counter == -1) {
-            counter = new Random().nextInt() & 0xffff;
+        long n = LazyInitialization.random.nextLong();
+        if (n == Long.MIN_VALUE) {
+            n = 0;      // corner case
+        } else {
+            n = Math.abs(n);
         }
-        counter++;
-        return new File(dir, prefix + Integer.toString(counter) + suffix);
+        return new File(dir, prefix + Long.toString(n) + suffix);
     }
 
-    private static String tmpdir; /* Protected by tmpFileLock */
-
-    private static String getTempDir() {
-        if (tmpdir == null)
-            tmpdir = fs.normalize(
-                AccessController.doPrivileged(
-                    new GetPropertyAction("java.io.tmpdir")));
-        return tmpdir;
-    }
-
     private static boolean checkAndCreate(String filename, SecurityManager sm)
         throws IOException
     {
@@ -1793,18 +1793,16 @@
         if (prefix.length() < 3)
             throw new IllegalArgumentException("Prefix string too short");
         String s = (suffix == null) ? ".tmp" : suffix;
-        synchronized (tmpFileLock) {
-            if (directory == null) {
-                String tmpDir = getTempDir();
-                directory = new File(tmpDir, fs.prefixLength(tmpDir));
-            }
-            SecurityManager sm = System.getSecurityManager();
-            File f;
-            do {
-                f = generateFile(prefix, s, directory);
-            } while (!checkAndCreate(f.getPath(), sm));
-            return f;
+        if (directory == null) {
+            String tmpDir = LazyInitialization.temporaryDirectory();
+            directory = new File(tmpDir, fs.prefixLength(tmpDir));
         }
+        SecurityManager sm = System.getSecurityManager();
+        File f;
+        do {
+            f = generateFile(prefix, s, directory);
+        } while (!checkAndCreate(f.getPath(), sm));
+        return f;
     }
 
     /**
--- /dev/null	Thu Oct  9 16:12:28 2008
+++ openjdk/jdk/test/closed/java/io/File/createTempFile/GuessNext.java	Thu Oct  9 16:12:25 2008
@@ -0,0 +1,26 @@
+/* @test
+ * @bug 6721753
+ * @key closed-security
+ * @summary Test that temporary files don't use incrementing counter
+ */
+
+import java.io.File;
+import java.io.IOException;
+import java.util.regex.*;
+
+public class GuessNext {
+    public static void main (String[] args) throws IOException {
+        String name = File.createTempFile("blah", null).getName();
+
+        // assume name is blahNNNNNN
+        Matcher matcher = Pattern.compile("([0-9]+)").matcher(name);
+        if (matcher.find()) {
+            long next = Long.parseLong(matcher.group(1)) + 1;
+            String guess = "blah" + next + ".tmp";
+
+            name = File.createTempFile("blah", null).getName();
+            if (name.equals(guess))
+                throw new RuntimeException("Incrementing number");
+        }
+    }
+}
